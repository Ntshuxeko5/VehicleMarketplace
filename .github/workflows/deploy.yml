name: CD Deploy to AWS

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
  BACKEND_IMAGE: vehiclemarketplace-backend
  FRONTEND_IMAGE: vehiclemarketplace-frontend

jobs:
  deploy:
    name: Build and Deploy to AWS
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2
      
    - name: Extract version from tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Build, tag, and push backend image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.version.outputs.VERSION }}
      run: |
        docker buildx build \
          --platform linux/amd64 \
          -t $ECR_REGISTRY/$BACKEND_IMAGE:$IMAGE_TAG \
          -t $ECR_REGISTRY/$BACKEND_IMAGE:latest \
          -f Dockerfile.backend \
          --push \
          .
          
    - name: Build, tag, and push frontend image to Amazon ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.version.outputs.VERSION }}
      run: |
        docker buildx build \
          --platform linux/amd64 \
          -t $ECR_REGISTRY/$FRONTEND_IMAGE:$IMAGE_TAG \
          -t $ECR_REGISTRY/$FRONTEND_IMAGE:latest \
          -f src/VehicleMarketplace.Web/Dockerfile \
          --push \
          src/VehicleMarketplace.Web
          
    - name: Deploy to ECS (Backend)
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.version.outputs.VERSION }}
      run: |
        # Update ECS service with new backend image
        aws ecs update-service \
          --cluster vehiclemarketplace-cluster \
          --service backend-service \
          --force-new-deployment \
          --region ${{ env.AWS_REGION }}
          
    - name: Deploy to ECS (Frontend)
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.version.outputs.VERSION }}
      run: |
        # Update ECS service with new frontend image
        aws ecs update-service \
          --cluster vehiclemarketplace-cluster \
          --service frontend-service \
          --force-new-deployment \
          --region ${{ env.AWS_REGION }}
          
    - name: Wait for deployment to complete
      run: |
        aws ecs wait services-stable \
          --cluster vehiclemarketplace-cluster \
          --services backend-service frontend-service \
          --region ${{ env.AWS_REGION }}
          
    - name: Deployment summary
      run: |
        echo "âœ… Deployment complete!"
        echo "Version: ${{ steps.version.outputs.VERSION }}"
        echo "Backend image: ${{ env.ECR_REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ steps.version.outputs.VERSION }}"
        echo "Frontend image: ${{ env.ECR_REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ steps.version.outputs.VERSION }}"
